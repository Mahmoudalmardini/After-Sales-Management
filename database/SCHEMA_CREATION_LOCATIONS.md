# Database Schema Creation Locations

## Overview

There are **multiple places** where database tables can be created in this project. Here's a comprehensive list:

---

## 1. **database/init.sql** (Manual SQL Script) ✅ JUST FIXED

**Location**: `database/init.sql`

**Purpose**: 
- Manual PostgreSQL initialization script
- Used by Docker Compose for initial database setup
- Can be run manually for PostgreSQL setup

**When it runs**:
- Automatically when PostgreSQL Docker container starts for the first time
- Manually: `psql -U user -d database -f database/init.sql`

**Status**: ✅ **FIXED** - Circular dependency resolved

**Database Type**: PostgreSQL (uses `SERIAL`, `TIMESTAMP`, etc.)

**Usage**:
```bash
# Via Docker Compose (automatic)
docker-compose up postgres

# Manual execution
psql $DATABASE_URL -f database/init.sql
```

---

## 2. **Prisma Migrations** (Generated SQL Files)

**Location**: `backend/prisma/migrations/`

**Files**:
- `20250930195642_add_spare_part_history/migration.sql` (Main schema)
- `20250101000000_add_serial_number_to_requests/migration.sql`
- `20251023014000_make_purchase_date_required/migration.sql`
- `001_add_currency_support.sql`
- `002_update_partnumber_to_int.sql`

**Purpose**:
- Version-controlled database schema changes
- Generated by Prisma from `schema.prisma`
- Used for production deployments

**When it runs**:
- `npx prisma migrate deploy` (production)
- `npx prisma migrate dev` (development)

**Status**: ⚠️ **Note**: These migrations were generated for SQLite initially (use `INTEGER PRIMARY KEY AUTOINCREMENT`)
- For PostgreSQL, use `npx prisma migrate deploy` which handles schema properly
- Prisma automatically handles circular dependencies when executing migrations

**Database Type**: Generated for SQLite, but Prisma adapts for PostgreSQL

**Usage**:
```bash
cd backend

# Production (applies all migrations)
npx prisma migrate deploy

# Development (creates new migrations)
npx prisma migrate dev
```

---

## 3. **Prisma Schema** (Source of Truth)

**Location**: `backend/prisma/schema.prisma`

**Purpose**:
- Source of truth for database schema
- Defines models, relationships, types
- Does NOT directly create tables
- Used by Prisma to generate:
  - Prisma Client (TypeScript types)
  - Migrations (SQL files)
  - Schema sync (`db push`)

**When it's used**:
- `npx prisma generate` - Generates Prisma Client
- `npx prisma db push` - Syncs schema directly to database (bypasses migrations)
- `npx prisma migrate dev` - Creates new migrations from schema changes

**Status**: ✅ **Correct** - Prisma handles circular dependencies automatically

**Usage**:
```bash
cd backend

# Generate Prisma Client (TypeScript types)
npx prisma generate

# Sync schema directly to database (development)
npx prisma db push

# Create migration from schema changes
npx prisma migrate dev --name description
```

---

## 4. **Prisma db push** (Direct Schema Sync)

**Location**: Generated from `backend/prisma/schema.prisma`

**Purpose**:
- Directly syncs Prisma schema to database
- Bypasses migration system
- Useful for development/prototyping
- Handles circular dependencies automatically

**When it runs**:
- `npx prisma db push` command
- Used in deployment scripts (`deploy.sh`, `deploy.js`)
- Used in development setup scripts

**Status**: ✅ **Works correctly** - Prisma handles circular dependencies

**Usage**:
```bash
cd backend

# Sync schema to database
npx prisma db push

# With data loss (accepts schema changes that might cause data loss)
npx prisma db push --accept-data-loss
```

---

## Summary Table

| Location | Type | Database | Auto-fixes Circular Deps? | When Used |
|----------|------|----------|---------------------------|-----------|
| `database/init.sql` | Manual SQL | PostgreSQL | ❌ (now ✅ fixed) | Docker, manual setup |
| `backend/prisma/migrations/` | Generated SQL | SQLite/PostgreSQL | ✅ (Prisma handles) | `prisma migrate deploy` |
| `backend/prisma/schema.prisma` | Prisma Schema | Database-agnostic | ✅ (Prisma handles) | Source of truth |
| `prisma db push` | Generated from schema | Any | ✅ (Prisma handles) | Development, quick sync |

---

## Which One Should You Use?

### For Development:
1. **Prisma Schema + db push** (Recommended)
   ```bash
   cd backend
   npx prisma generate
   npx prisma db push
   ```

### For Production:
1. **Prisma Migrations** (Recommended)
   ```bash
   cd backend
   npx prisma generate
   npx prisma migrate deploy
   ```

### For Docker Setup:
1. **database/init.sql** (Used automatically)
   - Already configured in `docker-compose.yml`
   - Runs when PostgreSQL container starts

### For Manual PostgreSQL Setup:
1. **database/init.sql** (Now fixed!)
   ```bash
   psql $DATABASE_URL -f database/init.sql
   ```

---

## Important Notes

### Circular Dependency Handling

1. **database/init.sql**: 
   - ✅ **FIXED** - Now uses `ALTER TABLE` to add foreign key after both tables exist

2. **Prisma Migrations**:
   - ✅ **Handled automatically** - Prisma creates tables in correct order
   - Even if migration SQL has circular references, Prisma's migration system handles it

3. **Prisma Schema + db push**:
   - ✅ **Handled automatically** - Prisma resolves circular dependencies when syncing

### Migration Files Note

⚠️ The Prisma migration files in `backend/prisma/migrations/` were originally generated for SQLite:
- Uses `INTEGER PRIMARY KEY AUTOINCREMENT` instead of `SERIAL`
- Uses `TEXT` instead of `VARCHAR`
- Uses `DATETIME` instead of `TIMESTAMP`

However:
- When you run `npx prisma migrate deploy` on PostgreSQL, Prisma adapts the SQL
- The migration system handles database-specific differences
- For new migrations, Prisma generates appropriate SQL for your target database

---

## Recommendations

### For Fresh Database Setup:

**Option 1: Using Prisma (Recommended)**
```bash
cd backend
npx prisma generate
npx prisma db push
npx prisma db seed  # Optional: add dummy data
```

**Option 2: Using init.sql (For Docker or Manual)**
```bash
# Docker (automatic)
docker-compose up postgres

# Manual
psql $DATABASE_URL -f database/init.sql
```

### For Production Deployment:

**Use Prisma Migrations:**
```bash
cd backend
npx prisma generate
npx prisma migrate deploy
```

### For Development:

**Use Prisma db push:**
```bash
cd backend
npx prisma generate
npx prisma db push
```

---

## Current Status

- ✅ `database/init.sql` - **FIXED** (circular dependency resolved)
- ✅ Prisma Schema - **Correct** (handles dependencies automatically)
- ✅ Prisma db push - **Works** (handles dependencies automatically)
- ✅ Prisma Migrations - **Works** (Prisma handles execution order)

All schema creation methods are now correct and ready to use!
