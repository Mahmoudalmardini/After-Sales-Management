import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

type Lang = 'en' | 'ar';

const translations: Record<Lang, Record<string, string>> = {
  en: {
    'requests.title': 'طلبات الخدمة',
    'requests.subtitle': 'إدارة ومتابعة جميع طلبات الخدمة',
    'requests.new': 'New Request',
    'requests.search.placeholder': 'Search by number, issue, customer, product',
    'requests.filters.status': 'All Statuses',
    'requests.filters.priority': 'All Priorities',
    'requests.table.number': 'Number',
    'requests.table.customer': 'Customer',
    'requests.table.department': 'Department',
    'requests.table.technician': 'Technician',
    'requests.table.status': 'Status',
    'requests.table.priority': 'Priority',
    'requests.table.created': 'Created',
    'requests.table.view': 'View',
    'requests.empty': 'No requests found',
    'requests.loading': 'Loading...',
    'create.title': 'Create New Request',
    'create.subtitle': 'Create a new service request for a customer',
    'create.customer': 'Customer',
    'create.product': 'Product (optional)',
    'create.executionMethod': 'Execution Method',
    'create.warrantyStatus': 'Warranty Status',
    'create.priority': 'Priority',
    'create.purchaseDate': 'Purchase Date (optional)',
    'create.issue': 'Issue Description',
    'create.issue.placeholder': 'Describe the issue...',
    'create.submit': 'Create Request',
    'create.cancel': 'Cancel',
    'details.title': 'Request Details',
    'details.subtitle': 'View and manage request details',
    'details.back': 'Back',
    'details.overview': 'Overview',
    'details.number': 'Number',
    'details.status': 'Status',
    'details.customer': 'Customer',
    'details.department': 'Department',
    'details.technician': 'Technician',
    'details.priority': 'Priority',
    'details.issue': 'Issue',
    'details.activities': 'Activities',
    'details.activities.empty': 'No activities yet.',
    'details.costs': 'Costs',
    'details.costs.add': 'Add',
    'details.assign': 'Assign Technician',
    'details.updateStatus': 'Update Status',
    'details.close': 'Close Request',
    'details.finalNotes': 'Final notes',
    'details.satisfaction': 'Customer satisfaction (1-5)',
    'pagination.prev': 'Previous',
    'pagination.next': 'Next',
    'pagination.pageOf': 'Page {page} of {totalPages} • {total} total',
    // Navigation
    'nav.dashboard': 'Dashboard',
    'nav.requests': 'Requests',
    'nav.customers': 'العملاء',
    'nav.products': 'المنتجات',
    'nav.users': 'Users',
    'nav.reports': 'Reports',
    'dashboard.stats.totalRequests': 'Total Requests',
    'dashboard.stats.overdueRequests': 'Overdue Requests',
    'dashboard.stats.completedRequests': 'Completed',
    'dashboard.stats.pendingRequests': 'Pending Requests',
    'dashboard.stats.underWarranty': 'Under Warranty',
    'dashboard.stats.outOfWarranty': 'Out of Warranty',
    // Customers
    'customers.title': 'العملاء',
    'customers.subtitle': 'إدارة معلومات العملاء',
    'customers.add': 'Add Customer',
    'customers.name': 'Name',
    'customers.phone': 'Phone',
    'customers.email': 'Email',
    'customers.city': 'City',
    'customers.address': 'Address',
    'customers.loading': 'Loading customers...',
    'customers.empty': 'No customers found',
    'customers.save': 'Save',
    'customers.cancel': 'Cancel',
    // Products
    'products.title': 'المنتجات',
    'products.subtitle': 'إدارة كتالوج المنتجات',
    'products.add': 'Add Product',
    'products.name': 'Name',
    'products.model': 'Model',
    'products.serial': 'Serial Number',
    'products.category': 'Category',
    'products.department': 'Department',
    'products.warranty': 'Warranty (months)',
    'products.loading': 'Loading products...',
    'products.empty': 'No products found',
    'products.save': 'Save',
    'products.cancel': 'Cancel',
    // Users
    'users.title': 'Users',
    'users.subtitle': 'Manage system users and permissions',
    'users.allRoles': 'All roles',
    'users.allDepartments': 'All departments',
    'users.refresh': 'Refresh',
    'users.name': 'Name',
    'users.username': 'Username',
    'users.email': 'Email',
    'users.role': 'Role',
    'users.department': 'Department',
    'users.loading': 'Loading users...',
    'users.empty': 'No users found',
    // Reports
    'reports.title': 'Reports & Analytics',
    'reports.subtitle': 'View performance metrics and generate reports',
    'reports.totalRequests': 'Total Requests',
    'reports.overdueRequests': 'Overdue Requests',
    'reports.completed': 'Completed',
    'reports.overdue': 'Overdue Requests',
    'reports.onTimePercentage': 'On-time %',
    'reports.avgResolutionHours': 'Avg. resolution (hrs)',
    // Export
    'export.title': 'Export Reports',
    'export.subtitle': 'Download Excel reports for different data sets',
    'export.allRequests': 'Export All Requests',
    'export.overdueRequests': 'Export Overdue Requests',
    'export.byStatus': 'Export by Status',
    'export.byDepartment': 'Export by Department',
    'export.byWarranty': 'Export by Warranty Status',
    'export.dashboardStats': 'Export Dashboard Statistics',
    'export.downloading': 'Downloading...',
    'export.success': 'File downloaded successfully',
    'export.error': 'Failed to download file',
    // Login
    'login.title': 'Sign in to your account',
    'login.subtitle': 'Access the after-sales service management system',
    'login.username': 'Username',
    'login.password': 'Password',
    'login.usernamePlaceholder': 'Enter your username',
    'login.passwordPlaceholder': 'Enter your password',
    'login.signin': 'Sign in',
    'login.signingIn': 'Signing in...',
    'login.fillAllFields': 'Please fill in all fields',
    'login.failed': 'Login failed. Please check your credentials.',
    'login.demoCredentials': 'Demo Credentials:',
    'login.companyManager': 'Company Manager:',
    'login.deputyManager': 'Deputy Manager:',
    'login.lgManager': 'LG Manager:',
    'login.technician': 'Technician:',
    // Common
    'common.loading': 'Loading...',
    'common.error': 'Error',
    'common.success': 'Success',
    'common.save': 'Save',
    'common.cancel': 'Cancel',
    'common.submit': 'Submit',
    'common.create': 'Create',
    'common.edit': 'Edit',
    'common.delete': 'Delete',
    'common.update': 'Update',
    'common.close': 'Close',
    'common.open': 'Open',
    'common.add': 'Add',
    'common.view': 'View',
    'common.search': 'Search',
    'common.filter': 'Filter',
    'common.actions': 'Actions',
    'common.status': 'Status',
    'common.name': 'Name',
    'common.email': 'Email',
    'common.phone': 'Phone',
    'common.address': 'Address',
    'common.description': 'Description',
    'common.date': 'Date',
    'common.time': 'Time',
    'common.amount': 'Amount',
    'common.total': 'Total',
    'common.new': 'New',
    'common.yes': 'Yes',
    'common.no': 'No',
    'common.required': 'Required',
    'common.optional': 'Optional',
    'common.select': 'Select',
    'common.selectOption': 'Select an option',
    'common.all': 'All',
    'common.none': 'None',
    'common.back': 'Back',
    'common.next': 'Next',
    'common.previous': 'Previous',
    'common.first': 'First',
    'common.last': 'Last',
    // Errors
    'error.failedToLoad': 'Failed to load data',
    'error.failedToSave': 'Failed to save data',
    'error.failedToDelete': 'Failed to delete data',
    'error.failedToUpdate': 'Failed to update data',
    'error.failedToCreate': 'Failed to create data',
    'error.networkError': 'Network error',
    'error.serverError': 'Server error',
    'error.unauthorized': 'Unauthorized',
    'error.forbidden': 'Forbidden',
    'error.notFound': 'Not found',
    'error.validation': 'Validation error',
    // App
    'app.name': 'After-Sales',
    'app.subtitle': 'Service Management',
    'app.fullTitle': 'After-Sales Service Management',
    'app.description': 'Internal management system for service and maintenance',
    'app.copyright': '© 2024 After-Sales Service Management System. All rights reserved.',
  },
  ar: {
    'requests.title': 'طلبات الخدمة',
    'requests.subtitle': 'إدارة ومتابعة جميع طلبات الخدمة',
    'requests.new': 'طلب جديد',
    'requests.search.placeholder': 'ابحث بالرقم أو المشكلة أو العميل أو المنتج',
    'requests.filters.status': 'كل الحالات',
    'requests.filters.priority': 'كل الأولويات',
    'requests.table.number': 'الرقم',
    'requests.table.customer': 'العميل',
    'requests.table.department': 'القسم',
    'requests.table.technician': 'الفني',
    'requests.table.status': 'الحالة',
    'requests.table.priority': 'الأولوية',
    'requests.table.created': 'تاريخ الإنشاء',
    'requests.table.view': 'عرض',
    'requests.empty': 'لا توجد طلبات',
    'requests.loading': 'جاري التحميل...',
    'create.title': 'إنشاء طلب جديد',
    'create.subtitle': 'إنشاء طلب صيانة جديد لعميل',
    'create.customer': 'العميل',
    'create.product': 'المنتج (اختياري)',
    'create.executionMethod': 'طريقة التنفيذ',
    'create.warrantyStatus': 'حالة الكفالة',
    'create.warrantyUnder': 'ضمن الكفالة',
    'create.warrantyOut': 'خارج الكفالة',
    'create.executionOnsite': 'زيارة فني',
    'create.executionWorkshop': 'إحضار للورشة',
    'create.priority': 'الأولوية',
    'create.purchaseDate': 'تاريخ الشراء (اختياري)',
    'create.issue': 'وصف المشكلة',
    'create.issue.placeholder': 'صف المشكلة...',
    'create.submit': 'إنشاء الطلب',
    'create.cancel': 'إلغاء',
    'details.title': 'تفاصيل الطلب',
    'details.subtitle': 'عرض وإدارة تفاصيل الطلب',
    'details.back': 'رجوع',
    'details.overview': 'نظرة عامة',
    'details.number': 'الرقم',
    'details.status': 'الحالة',
    'details.customer': 'العميل',
    'details.department': 'القسم',
    'details.technician': 'الفني',
    'details.priority': 'الأولوية',
    'details.issue': 'المشكلة',
    'details.activities': 'الأنشطة',
    'details.activities.empty': 'لا توجد أنشطة بعد.',
    'details.costs': 'التكاليف',
    'details.costs.add': 'إضافة',
    'details.assign': 'تعيين فني',
    'details.updateStatus': 'تحديث الحالة',
    'details.close': 'إغلاق الطلب',
    'details.finalNotes': 'ملاحظات ختامية',
    'details.satisfaction': 'رضا العميل (1-5)',
    'pagination.prev': 'السابق',
    'pagination.next': 'التالي',
    'pagination.pageOf': 'الصفحة {page} من {totalPages} • {total} إجمالي',
    // Navigation
    'nav.dashboard': 'لوحة التحكم',
    'nav.requests': 'الطلبات',
    'nav.customers': 'العملاء',
    'nav.products': 'المنتجات',
    'nav.users': 'المستخدمين',
    'nav.reports': 'التقارير',
    'dashboard.stats.totalRequests': 'إجمالي الطلبات',
    'dashboard.stats.overdueRequests': 'الطلبات المتأخرة',
    'dashboard.stats.completedRequests': 'المكتملة',
    'dashboard.stats.pendingRequests': 'الطلبات المعلقة',
    'dashboard.stats.underWarranty': 'ضمن الكفالة',
    'dashboard.stats.outOfWarranty': 'خارج الكفالة',
    // Customers
    'customers.title': 'العملاء',
    'customers.subtitle': 'إدارة معلومات العملاء',
    'customers.add': 'إضافة عميل',
    'customers.name': 'الاسم',
    'customers.phone': 'الهاتف',
    'customers.email': 'البريد الإلكتروني',
    'customers.city': 'المدينة',
    'customers.address': 'العنوان',
    'customers.loading': 'جاري تحميل العملاء...',
    'customers.empty': 'لا يوجد عملاء',
    'customers.save': 'حفظ',
    'customers.cancel': 'إلغاء',
    // Products
    'products.title': 'المنتجات',
    'products.subtitle': 'إدارة كتالوج المنتجات',
    'products.add': 'إضافة منتج',
    'products.name': 'الاسم',
    'products.model': 'الموديل',
    'products.serial': 'الرقم التسلسلي',
    'products.category': 'التصنيف',
    'products.department': 'القسم',
    'products.warranty': 'الضمان (أشهر)',
    'products.loading': 'جاري تحميل المنتجات...',
    'products.empty': 'لا يوجد منتجات',
    'products.save': 'حفظ',
    'products.cancel': 'إلغاء',
    // Users
    'users.title': 'المستخدمون',
    'users.subtitle': 'إدارة المستخدمين والصلاحيات',
    'users.allRoles': 'كل الأدوار',
    'users.allDepartments': 'كل الأقسام',
    'users.refresh': 'تحديث',
    'users.name': 'الاسم',
    'users.username': 'اسم المستخدم',
    'users.email': 'البريد الإلكتروني',
    'users.role': 'الدور',
    'users.department': 'القسم',
    'users.loading': 'جاري تحميل المستخدمين...',
    'users.empty': 'لا يوجد مستخدمين',
    // Reports
    'reports.title': 'التقارير والتحليلات',
    'reports.subtitle': 'عرض مؤشرات الأداء وإنشاء التقارير',
    'reports.totalRequests': 'إجمالي الطلبات',
    'reports.overdueRequests': 'الطلبات المتأخرة',
    'reports.completed': 'المكتملة',
    'reports.overdue': 'الطلبات المتأخرة',
    'reports.onTimePercentage': 'نسبة في الوقت',
    'reports.avgResolutionHours': 'متوسط الحل (ساعات)',
    // Export
    'export.title': 'تصدير التقارير',
    'export.subtitle': 'تحميل تقارير Excel لمجموعات البيانات المختلفة',
    'export.allRequests': 'تصدير جميع الطلبات',
    'export.overdueRequests': 'تصدير الطلبات المتأخرة',
    'export.byStatus': 'تصدير حسب الحالة',
    'export.byDepartment': 'تصدير حسب القسم',
    'export.byWarranty': 'تصدير حسب حالة الكفالة',
    'export.dashboardStats': 'تصدير إحصائيات لوحة التحكم',
    'export.downloading': 'جاري التحميل...',
    'export.success': 'تم تحميل الملف بنجاح',
    'export.error': 'فشل في تحميل الملف',
    // Login
    'login.title': 'تسجيل الدخول إلى حسابك',
    'login.subtitle': 'الوصول إلى نظام إدارة خدمات ما بعد البيع',
    'login.username': 'اسم المستخدم',
    'login.password': 'كلمة المرور',
    'login.usernamePlaceholder': 'أدخل اسم المستخدم',
    'login.passwordPlaceholder': 'أدخل كلمة المرور',
    'login.signin': 'تسجيل الدخول',
    'login.signingIn': 'جاري تسجيل الدخول...',
    'login.fillAllFields': 'يرجى ملء جميع الحقول',
    'login.failed': 'فشل تسجيل الدخول. يرجى التحقق من بيانات الاعتماد.',
    'login.demoCredentials': 'بيانات اعتماد تجريبية:',
    'login.companyManager': 'مدير الشركة:',
    'login.deputyManager': 'نائب المدير:',
    'login.lgManager': 'مدير LG:',
    'login.technician': 'فني:',
    // Common
    'common.loading': 'جاري التحميل...',
    'common.error': 'خطأ',
    'common.success': 'نجح',
    'common.save': 'حفظ',
    'common.cancel': 'إلغاء',
    'common.submit': 'إرسال',
    'common.create': 'إنشاء',
    'common.edit': 'تعديل',
    'common.delete': 'حذف',
    'common.update': 'تحديث',
    'common.close': 'إغلاق',
    'common.open': 'فتح',
    'common.add': 'إضافة',
    'common.view': 'عرض',
    'common.search': 'بحث',
    'common.filter': 'تصفية',
    'common.actions': 'الإجراءات',
    'common.status': 'الحالة',
    'common.name': 'الاسم',
    'common.email': 'البريد الإلكتروني',
    'common.phone': 'الهاتف',
    'common.address': 'العنوان',
    'common.description': 'الوصف',
    'common.date': 'التاريخ',
    'common.time': 'الوقت',
    'common.amount': 'المبلغ',
    'common.total': 'الإجمالي',
    'common.new': 'جديد',
    'common.yes': 'نعم',
    'common.no': 'لا',
    'common.required': 'مطلوب',
    'common.optional': 'اختياري',
    'common.select': 'اختر',
    'common.selectOption': 'اختر خيار',
    'common.all': 'الكل',
    'common.none': 'لا شيء',
    'common.back': 'رجوع',
    'common.next': 'التالي',
    'common.previous': 'السابق',
    'common.first': 'الأول',
    'common.last': 'الأخير',
    // Errors
    'error.failedToLoad': 'فشل في تحميل البيانات',
    'error.failedToSave': 'فشل في حفظ البيانات',
    'error.failedToDelete': 'فشل في حذف البيانات',
    'error.failedToUpdate': 'فشل في تحديث البيانات',
    'error.failedToCreate': 'فشل في إنشاء البيانات',
    'error.networkError': 'خطأ في الشبكة',
    'error.serverError': 'خطأ في الخادم',
    'error.unauthorized': 'غير مصرح',
    'error.forbidden': 'ممنوع',
    'error.notFound': 'غير موجود',
    'error.validation': 'خطأ في التحقق',
    // App
    'app.name': 'ما بعد البيع',
    'app.subtitle': 'إدارة الخدمات',
    'app.fullTitle': 'إدارة خدمات ما بعد البيع',
    'app.description': 'نظام إدارة داخلي للخدمة والصيانة',
    'app.copyright': '© 2024 نظام إدارة خدمات ما بعد البيع. جميع الحقوق محفوظة.',
  },
};

type I18nContextType = {
  lang: Lang;
  dir: 'ltr' | 'rtl';
  t: (key: string, vars?: Record<string, string | number>) => string;
  setLang: (lang: Lang) => void;
};

const I18nContext = createContext<I18nContextType | undefined>(undefined);

function getInitialLang(): Lang {
  try {
    const saved = localStorage.getItem('lang');
    if (saved === 'ar' || saved === 'en') return saved;
  } catch {}
  return (navigator.language || 'en').toLowerCase().startsWith('ar') ? 'ar' : 'en';
}

export const I18nProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [lang, setLangState] = useState<Lang>(getInitialLang());

  useEffect(() => {
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    try { localStorage.setItem('lang', lang); } catch {}
  }, [lang]);

  const t = useMemo(() => (key: string, vars?: Record<string, string | number>) => {
    const dict = translations[lang] || translations.en;
    let value = dict[key] || translations.en[key] || key;
    if (vars) {
      Object.keys(vars).forEach(k => {
        value = value.replace(`{${k}}`, String(vars[k]));
      });
    }
    return value;
  }, [lang]);

  const setLang = (l: Lang) => setLangState(l);

  const dir = useMemo((): 'ltr' | 'rtl' => lang === 'ar' ? 'rtl' : 'ltr', [lang]);

  const value = useMemo(() => ({ lang, dir, t, setLang }), [lang, dir, t]);

  return (
    <I18nContext.Provider value={value}>
      {children}
    </I18nContext.Provider>
  );
};

export const useI18n = (): I18nContextType => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
};


